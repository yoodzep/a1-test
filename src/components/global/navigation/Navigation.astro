---
import Logo from "@/components/assets/Logo.astro";
// Icons
import Close from "@/components/fundations/icons/Close.astro";
import Burger from "@/components/fundations/icons/Burger.astro";
// Fundations
import Button from "@/components/fundations/elements/Button.astro";
import Wrapper from "@/components/fundations/containers/Wrapper.astro";
// Components
import Search from "@/components/global/Search.astro";
import MobileNavigation from "@/components/global/navigation/MobileNavigation.astro";
// Content
import { getCollection } from "astro:content";
// Allow pages/layouts to opt-in to transparent behavior; default is solid
const { transparent } = Astro.props as { transparent?: boolean };
const isTransparent = !!transparent;
// Fetch content collections for navigation
const services = (await getCollection("services")).sort((a, b) =>
  a.data.title.localeCompare(b.data.title)
);
const posts = (await getCollection("posts"))
  .slice()
  .sort(
    (a, b) =>
      new Date(b.data.pubDate).getTime() - new Date(a.data.pubDate).getTime()
  )
  .slice(0, 2);
const projects = (await getCollection("projects"))
  .filter((p) => p.data.featured)
  .slice(0, 1);
const navLinks = [
  { label: "About", href: "/about" },
  { label: "Services", href: "/services" },
  { label: "Projects", href: "/projects" },
  { label: "Team", href: "/team" },
  { label: "Careers", href: "/careers" },
  { label: "Blog", href: "/blog" },
  { label: "Contact", href: "/contact" },
  { label: "Overview", href: "/system/overview" },
];
---

<nav
  class={`fixed w-full top-0 z-50 transition-colors duration-300 border-b border-white/10 ${isTransparent ? "" : "bg-white"}`}
  data-nav
  data-swap={isTransparent ? "true" : "false"}
>
  <Wrapper variant="standard" class="relative lg:border-white/5">
    <div class="py-4 grid grid-cols-2 lg:grid-cols-4 items-center">
      <a
        href="/"
        aria-label="Home"
        data-logo
        class={`focus:outline-none text-2xl font-medium flex items-center gap-2   ${isTransparent ? "text-white" : "text-base-800"}`}
      >
        <span class="sr-only">Home</span>
        <Logo class="h-8" />
      </a>
      <div
        class="hidden lg:flex items-center justify-between gap-4 py-4 px-6 outline outline-white/10 rounded-full bg-white/5 backdrop-blur-sm lg:col-span-2"
      >
        {
          navLinks.map((l) => (
            <a
              href={l.href}
              class={`text-sm transition ${isTransparent ? "text-white " : "text-base-800"}`}
              data-primary-link
            >
              {l.label}
            </a>
          ))
        }
      </div>
      <div class="hidden lg:flex gap-2 items-center ml-auto">
        <Search />
        <Button
          isLink
          size="xs"
          variant="muted"
          href="https://buy.polar.sh/polar_cl_i4pEWDCILawXwqsTqrnidqYy7YZJ7Z3ncWHcR24AEaN"
          class="hidden lg:flex"
        >
          Buy Bastion
        </Button>
      </div>
      <button
        class={`lg:hidden ml-auto flex relative ${isTransparent ? "text-white" : "text-base-800"}`}
        aria-controls="mobile-menu"
        aria-expanded="false"
        data-menu-button
      >
        <span class="sr-only">Open main menu</span>
        <span
          class="block"
          style="display: var(--burger-display, block);"
          data-burger
        >
          <Burger size="xl" slot="icon" />
        </span>
        <span
          class="hidden"
          style="display: var(--close-display, none);"
          data-close
        >
          <Close size="xl" slot="icon" />
        </span>
      </button>
    </div>
    <!-- Mobile Menu -->
    <MobileNavigation navLinks={navLinks} />
  </Wrapper>
  <script is:inline>
    window.addEventListener("DOMContentLoaded", () => {
      // Mobile menu toggle logic
      const menuButton = document.querySelector("[data-menu-button]");
      const burger = menuButton
        ? menuButton.querySelector("[data-burger]")
        : null;
      const close = menuButton
        ? menuButton.querySelector("[data-close]")
        : null;
      const mobileMenu = document.getElementById("mobile-menu");
      // Icon toggle
      const updateIcons = () => {
        if (!menuButton || !burger || !close) return;
        const expanded = menuButton.getAttribute("aria-expanded") === "true";
        burger.style.setProperty(
          "--burger-display",
          expanded ? "none" : "block"
        );
        close.style.setProperty("--close-display", expanded ? "block" : "none");
      };
      const openMenu = () => {
        if (!menuButton || !mobileMenu) return;
        menuButton.setAttribute("aria-expanded", "true");
        mobileMenu.classList.remove(
          "max-h-0",
          "opacity-0",
          "-translate-y-2",
          "pointer-events-none"
        );
        mobileMenu.classList.add(
          "max-h-screen",
          "opacity-100",
          "translate-y-0",
          "pointer-events-auto"
        );
        updateIcons();
      };
      const closeMenu = () => {
        if (!menuButton || !mobileMenu) return;
        menuButton.setAttribute("aria-expanded", "false");
        mobileMenu.classList.add(
          "max-h-0",
          "opacity-0",
          "-translate-y-2",
          "pointer-events-none"
        );
        mobileMenu.classList.remove(
          "max-h-screen",
          "opacity-100",
          "translate-y-0",
          "pointer-events-auto"
        );
        updateIcons();
      };
      const toggleMenu = () => {
        const expanded = menuButton.getAttribute("aria-expanded") === "true";
        expanded ? closeMenu() : openMenu();
      };
      if (menuButton) menuButton.addEventListener("click", toggleMenu);
      // Click outside to close
      document.addEventListener("click", (e) => {
        const target = e.target;
        if (!mobileMenu.contains(target) && !menuButton.contains(target)) {
          const expanded = menuButton.getAttribute("aria-expanded") === "true";
          if (expanded) closeMenu();
        }
      });
      // Escape to close
      document.addEventListener("keydown", (e) => {
        if (
          e.key === "Escape" &&
          menuButton.getAttribute("aria-expanded") === "true"
        ) {
          closeMenu();
        }
      });
      updateIcons();
      // Scroll background + link colors
      const navEl = document.querySelector("[data-nav]");
      const logoEl = document.querySelector("[data-logo]");
      const primaryLinks = document.querySelectorAll("[data-primary-link]");
      // Swap between light and dark text classes
      // Only enable color swap on the homepage
      const enableScrollSwap = navEl && navEl.dataset.swap === "true";
      const swapColor = (el, scrolled) => {
        if (!el) return;
        el.classList.remove("text-white", "text-base-800");
        el.classList.add(scrolled ? "text-base-800" : "text-white");
      };
      const handleScroll = () => {
        if (!enableScrollSwap) return;
        const scrolled = window.scrollY > 0;
        if (navEl) navEl.classList.toggle("bg-white", scrolled);
        swapColor(logoEl, scrolled);
        primaryLinks.forEach((el) => swapColor(el, scrolled));
        // Mobile icons
        swapColor(burger, scrolled);
        swapColor(close, scrolled);
      };
      if (enableScrollSwap) {
        window.addEventListener("scroll", handleScroll);
        handleScroll(); // Initialize state on load
      } else {
        // Force dark variant on non-home pages
        if (navEl) navEl.classList.add("bg-white");
        swapColor(logoEl, true);
        primaryLinks.forEach((el) => swapColor(el, true));
        swapColor(burger, true);
        swapColor(close, true);
      }
    });
  </script>
</nav>
